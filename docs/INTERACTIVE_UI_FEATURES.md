# 交互式用户界面功能

## 概述

SSHAI 现在支持完整的交互式用户界面，提供类似现代终端的编辑体验，包括历史命令浏览、光标移动、文本编辑等功能，并完全支持中文字符。

## 新增功能

### 1. 历史命令管理

#### 功能特性
- **上下方向键浏览**: 使用 ↑ 和 ↓ 键浏览历史命令
- **智能去重**: 自动避免连续重复的命令
- **容量限制**: 最多保存 100 条历史命令
- **中文支持**: 完全支持中文历史命令的存储和显示

#### 使用方法
```
↑ (上方向键) - 浏览上一条历史命令
↓ (下方向键) - 浏览下一条历史命令
```

### 2. 光标移动和编辑

#### 功能特性
- **左右方向键**: 在输入行中移动光标
- **快捷键支持**: Ctrl+A 移动到行首，Ctrl+E 移动到行尾
- **插入编辑**: 在光标位置插入字符
- **智能删除**: 正确处理中文字符的删除

#### 使用方法
```
← (左方向键) - 向左移动光标
→ (右方向键) - 向右移动光标
Ctrl+A       - 移动光标到行首
Ctrl+E       - 移动光标到行尾
Backspace    - 删除光标前的字符
```

### 3. 中文字符支持

#### 功能特性
- **UTF-8 编码**: 完全支持 UTF-8 编码的中文字符
- **正确显示宽度**: 中文字符按 2 个字符宽度计算
- **精确光标定位**: 光标在中文字符间正确移动
- **智能删除**: 正确删除中文字符

#### 支持的操作
- 中文字符输入
- 中文字符编辑
- 中文历史命令
- 混合中英文编辑

### 4. 界面刷新机制

#### 功能特性
- **ANSI 转义序列**: 使用标准 ANSI 转义序列进行界面控制
- **智能刷新**: 只在必要时刷新界面，避免闪烁
- **残留清除**: 完全清除历史内容残留
- **光标同步**: 保持光标位置与显示内容同步

#### 技术实现
```
\033[K  - 清除从光标到行尾的内容
\033[C  - 向右移动光标
\033[D  - 向左移动光标
\r      - 回到行首
```

## 技术架构

### InputState 结构体

```go
type InputState struct {
    buffer     []rune // 使用rune数组处理Unicode字符
    cursorPos  int    // 光标位置（以rune为单位）
    displayPos int    // 显示位置（以字符宽度为单位）
}
```

### 核心方法

#### 文本操作
- `SetText(text string)` - 设置输入文本
- `InsertRune(r rune)` - 插入字符
- `DeleteRune() bool` - 删除字符
- `String() string` - 获取当前文本

#### 光标控制
- `MoveCursorLeft() bool` - 向左移动光标
- `MoveCursorRight() bool` - 向右移动光标
- `MoveCursorToStart()` - 移动到行首
- `MoveCursorToEnd()` - 移动到行尾

#### 显示管理
- `calculateDisplayWidth(runes []rune) int` - 计算显示宽度
- `clearCurrentLine()` - 清除当前行
- `refreshLine()` - 刷新行显示

## 键盘快捷键

| 按键 | 功能 | 说明 |
|------|------|------|
| ↑ | 上一条历史命令 | 浏览历史命令 |
| ↓ | 下一条历史命令 | 浏览历史命令 |
| ← | 向左移动光标 | 在当前输入行中移动 |
| → | 向右移动光标 | 在当前输入行中移动 |
| Ctrl+A | 移动到行首 | 快速定位 |
| Ctrl+E | 移动到行尾 | 快速定位 |
| Ctrl+C | 中断当前操作 | 取消当前输入或AI响应 |
| Backspace | 删除前一个字符 | 支持中文字符 |
| Enter | 执行命令 | 发送消息给AI |

## 使用场景

### 1. 命令编辑
```
用户输入: 你好，我想了解一下人工智能
使用 ← → 键移动光标到"人工智能"前
插入文字: 你好，我想了解一下现代人工智能
```

### 2. 历史命令复用
```
1. 输入: 什么是机器学习？
2. 输入: 深度学习的原理是什么？
3. 按 ↑ 键回到: 深度学习的原理是什么？
4. 按 ↑ 键回到: 什么是机器学习？
5. 编辑后执行: 什么是强化学习？
```

### 3. 中英文混合编辑
```
输入: Hello 世界
光标移动和编辑都能正确处理中英文字符的宽度差异
```

## 测试方法

### 运行测试脚本
```bash
./scripts/test_interactive_ui.sh
```

### 手动测试步骤
1. 启动 SSHAI 服务器
2. 通过 SSH 连接到服务器
3. 测试各种键盘操作
4. 验证中文字符处理
5. 检查界面刷新效果

### 测试用例
- [ ] 基本字符输入
- [ ] 中文字符输入
- [ ] 历史命令浏览
- [ ] 光标移动编辑
- [ ] 快捷键功能
- [ ] 界面刷新
- [ ] 混合编辑场景

## 兼容性

### 终端支持
- 支持标准 ANSI 转义序列的终端
- SSH 客户端（如 OpenSSH、PuTTY）
- 现代终端模拟器

### 字符编码
- UTF-8 编码支持
- Unicode 字符处理
- 多字节字符正确显示

## 性能优化

### 内存管理
- 使用 `[]rune` 而非 `[]byte` 处理 Unicode
- 历史命令数量限制（100条）
- 及时清理无效转义序列

### 显示优化
- 最小化界面刷新
- 智能光标定位
- 减少不必要的重绘

## 故障排除

### 常见问题

#### 1. 中文字符显示异常
**原因**: 终端不支持 UTF-8 编码
**解决**: 确保 SSH 客户端和终端支持 UTF-8

#### 2. 方向键不工作
**原因**: 终端不支持 ANSI 转义序列
**解决**: 使用支持标准转义序列的终端

#### 3. 光标位置错误
**原因**: 字符宽度计算错误
**解决**: 检查 `calculateDisplayWidth` 函数

### 调试方法
1. 检查终端类型和编码设置
2. 验证 ANSI 转义序列支持
3. 测试基本字符输入输出
4. 逐步测试复杂功能

## 未来改进

### 计划功能
- [ ] 多行编辑支持
- [ ] 语法高亮
- [ ] 自动补全
- [ ] 搜索历史命令
- [ ] 自定义快捷键

### 性能优化
- [ ] 更高效的显示算法
- [ ] 减少网络传输
- [ ] 优化内存使用

## 总结

新的交互式用户界面功能大大提升了 SSHAI 的用户体验，提供了现代终端应有的编辑功能，特别是对中文用户的友好支持。通过完善的键盘快捷键、智能的界面刷新和强大的中文处理能力，用户可以更加高效地与 AI 助手进行交互。