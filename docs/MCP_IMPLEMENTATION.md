# MCP功能实现文档

## 概述

SSHAI项目已成功集成MCP（Model Context Protocol）功能支持，允许AI助手通过标准化协议调用外部工具和服务。

## 功能特性

### 支持的传输协议
- **stdio**: 通过标准输入输出与MCP服务器通信
- **http/streamable**: 通过HTTP协议与MCP服务器通信  
- **sse**: 通过Server-Sent Events与MCP服务器通信

### 核心功能
1. **自动工具发现**: 程序启动时自动连接配置的MCP服务器并获取可用工具列表
2. **定期刷新**: 定期刷新工具列表以获取最新的工具信息
3. **智能工具调用**: AI模型可以根据用户需求自动选择和调用合适的工具
4. **交互式反馈**: 在交互模式下显示工具调用过程和结果
5. **多服务器支持**: 支持同时连接多个MCP服务器

## 配置说明

在`config.yaml`中添加MCP配置：

```yaml
# MCP (Model Context Protocol) 配置
mcp:
  enabled: true  # 启用MCP功能
  refresh_interval: 300  # 工具列表刷新间隔（秒）
  servers:  # MCP服务器列表
    # stdio传输方式示例
    - name: "filesystem"
      transport: "stdio"
      command: ["mcp-server-filesystem", "/path/to/directory"]
      enabled: true
    
    # HTTP传输方式示例
    - name: "web-search"
      transport: "http"
      url: "http://localhost:8080/mcp"
      headers:
        Authorization: "Bearer your-token"
      enabled: true
```

## 架构设计

### 核心组件

1. **MCPManager** (`pkg/mcp/client.go`)
   - 管理所有MCP服务器连接
   - 处理工具列表的获取和刷新
   - 提供工具调用接口

2. **全局管理器** (`pkg/mcp/manager.go`)
   - 提供全局单例MCP管理器
   - 处理初始化和清理

3. **工具处理器** (`pkg/ai/tool_handler.go`)
   - 处理AI模型的工具调用请求
   - 将OpenAI工具调用转换为MCP工具调用

4. **配置扩展** (`pkg/config/config.go`)
   - 扩展配置结构支持MCP设置

### 工作流程

1. **启动阶段**:
   - 程序启动时初始化MCP管理器
   - 根据配置连接到各个MCP服务器
   - 获取并缓存所有可用工具列表

2. **运行阶段**:
   - AI客户端将MCP工具转换为OpenAI工具格式
   - 将工具列表传递给AI模型
   - AI模型根据用户需求决定是否调用工具

3. **工具调用**:
   - AI模型发起工具调用请求
   - 工具处理器解析请求参数
   - 通过MCP协议调用对应服务器的工具
   - 返回执行结果给AI模型

4. **定期维护**:
   - 定期刷新工具列表
   - 监控服务器连接状态

## 使用场景

### 交互模式
- 用户通过SSH连接到SSHAI
- AI助手可以根据对话内容自动调用相关工具
- 工具调用过程和结果会实时显示给用户

### 管道模式
- 通过管道输入内容到SSHAI
- AI分析内容并可能调用相关工具进行处理
- 工具调用在后台进行，不显示过程信息

### 命令模式
- 通过SSH exec执行单次命令
- AI处理命令并可能调用工具
- 工具调用在后台进行

## 安全考虑

1. **权限控制**: 通过配置控制哪些MCP服务器可以连接
2. **参数验证**: 验证工具调用参数的合法性
3. **超时控制**: 设置工具调用超时时间防止阻塞
4. **错误处理**: 完善的错误处理和恢复机制

## 扩展性

- **插件化设计**: 可以轻松添加新的传输协议支持
- **配置驱动**: 通过配置文件灵活控制MCP功能
- **模块化架构**: MCP功能作为独立模块，不影响核心功能

## 故障排除

### 常见问题

1. **连接失败**
   - 检查MCP服务器是否正常运行
   - 验证配置中的命令或URL是否正确
   - 查看日志获取详细错误信息

2. **工具调用失败**
   - 检查工具参数是否符合要求
   - 验证MCP服务器是否支持该工具
   - 检查网络连接和权限设置

3. **性能问题**
   - 调整工具列表刷新间隔
   - 检查MCP服务器响应时间
   - 考虑禁用不必要的MCP服务器

## 开发指南

### 添加新的传输协议

1. 在`MCPManager.connectToServer`中添加新的case
2. 实现对应的传输创建函数
3. 更新配置结构和文档

### 自定义工具处理

1. 扩展`Tool`结构体添加新字段
2. 在`handleToolCall`中添加自定义处理逻辑
3. 更新相关的错误处理和日志记录

## 版本兼容性

- 要求Go 1.23+
- 兼容MCP协议规范2025-06-18版本
- 使用官方go-sdk v0.5.0