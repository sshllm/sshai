name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write
  actions: read

env:
  PROJECT_NAME: sshai

jobs:
  build:
    name: Build for multiple platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: ""
          - goos: linux
            goarch: arm64
            suffix: ""
          - goos: darwin
            goarch: amd64
            suffix: ""
          - goos: darwin
            goarch: arm64
            suffix: ""
          - goos: windows
            goarch: amd64
            suffix: ".exe"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        
        GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GO_VERSION=$(go version | cut -d' ' -f3)
        
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "GIT_COMMIT=${GIT_COMMIT}" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_OUTPUT
        echo "GO_VERSION=${GO_VERSION}" >> $GITHUB_OUTPUT
        
        echo "Release Build Info:"
        echo "  Version: ${VERSION}"
        echo "  Commit: ${GIT_COMMIT}"
        echo "  Build Time: ${BUILD_TIME}"
        echo "  Go Version: ${GO_VERSION}"

    - name: Check language files
      run: |
        if [ ! -f "pkg/i18n/lang/lang-zh-cn.yaml" ]; then
          echo "Warning: Chinese language file not found, creating placeholder"
          mkdir -p pkg/i18n/lang
          echo "# Chinese language pack" > pkg/i18n/lang/lang-zh-cn.yaml
        fi
        if [ ! -f "pkg/i18n/lang/lang-en-us.yaml" ]; then
          echo "Warning: English language file not found, creating placeholder"
          mkdir -p pkg/i18n/lang
          echo "# English language pack" > pkg/i18n/lang/lang-en-us.yaml
        fi

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        OUTPUT_NAME="${PROJECT_NAME}_${{ matrix.goos }}_${{ matrix.goarch }}${{ matrix.suffix }}"
        
        # ä½¿ç”¨ä¸ŽMakefileç›¸åŒçš„LDFLAGS
        LDFLAGS="-X 'sshai/pkg/version.Version=${{ steps.version.outputs.VERSION }}' \
                 -X 'sshai/pkg/version.GitCommit=${{ steps.version.outputs.GIT_COMMIT }}' \
                 -X 'sshai/pkg/version.BuildTime=${{ steps.version.outputs.BUILD_TIME }}' \
                 -X 'sshai/pkg/version.GoVersion=${{ steps.version.outputs.GO_VERSION }}' \
                 -s -w"
        
        echo "Building ${OUTPUT_NAME} with version info..."
        go build -ldflags "${LDFLAGS}" -o "build/${OUTPUT_NAME}" cmd/main.go
        echo "BINARY_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV

    - name: Create release package
      run: |
        DIST_DIR="dist/${PROJECT_NAME}_${{ matrix.goos }}_${{ matrix.goarch }}"
        mkdir -p "$DIST_DIR"
        
        # Copy binary
        cp "build/${BINARY_NAME}" "$DIST_DIR/"
        
        # Copy config file
        cp config.yaml.example "$DIST_DIR/"
        
        # Create README
        cat > "$DIST_DIR/README.txt" << EOF
        SSHAI - SSH AI Assistant (Embedded Language Pack Version)
        Version: ${{ steps.version.outputs.VERSION }}
        Platform: ${{ matrix.goos }}/${{ matrix.goarch }}
        Git Commit: ${{ steps.version.outputs.GIT_COMMIT }}
        Build Time: ${{ steps.version.outputs.BUILD_TIME }}
        Go Version: ${{ steps.version.outputs.GO_VERSION }}

        Deployment Instructions:
        1. Copy ${BINARY_NAME} and config.yaml.example to your target server
        2. Modify config.yaml.example as needed
        3. Run ./${BINARY_NAME} to start the service

        Note: This version has language packs embedded in the binary, no additional language files needed.

        Configuration:
        - server.host: Server listening address
        - server.port: Server listening port
        - api.base_url: AI API base URL
        - language: Interface language (zh-cn or en-us)

        For more information: https://github.com/sshllm/sshai
        EOF
        
        # Create archive
        cd dist
        zip -r "${PROJECT_NAME}_${{ matrix.goos }}_${{ matrix.goarch }}_${{ steps.version.outputs.VERSION }}.zip" "${PROJECT_NAME}_${{ matrix.goos }}_${{ matrix.goarch }}/"
        cd ..
        
        echo "ARCHIVE_NAME=${PROJECT_NAME}_${{ matrix.goos }}_${{ matrix.goarch }}_${{ steps.version.outputs.VERSION }}.zip" >> $GITHUB_ENV

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}_${{ matrix.goos }}_${{ matrix.goarch }}
        path: |
          build/${{ env.BINARY_NAME }}
          dist/${{ env.ARCHIVE_NAME }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release_assets
        find artifacts -name "*.zip" -exec cp {} release_assets/ \;
        ls -la release_assets/

    - name: Generate release notes from commits
      id: release_notes
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        # å¦‚æžœæ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œä½¿ç”¨æœ€åˆçš„æäº¤
        if [ -z "$PREVIOUS_TAG" ]; then
          COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
        else
          COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
        fi
        
        echo "Generating release notes for commits: $COMMIT_RANGE"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æäº¤
        COMMIT_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
        if [ "$COMMIT_COUNT" = "0" ]; then
          echo "No commits found in range $COMMIT_RANGE, generating basic release notes"
          
          # ç”ŸæˆåŸºç¡€å‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
        # SSHAI ${{ steps.version.outputs.VERSION }} Release
        
        ## ðŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹
        
        ### ðŸ”§ å…¶ä»–æ›´æ”¹ (Other Changes)
        - ç‰ˆæœ¬å‘å¸ƒ: ${{ steps.version.outputs.VERSION }}
        - æž„å»ºä¼˜åŒ–å’Œç‰ˆæœ¬ç®¡ç†æ”¹è¿›
        
        ## ðŸŽ¯ æ ¸å¿ƒç‰¹æ€§ (Core Features)
        - SSH AI Assistant with embedded language packs
        - Multi-platform support (Linux, macOS, Windows)
        - Support for multiple AI models (DeepSeek, Hunyuan, etc.)
        - Real-time thinking display for compatible models
        - Configurable prompts and authentication
        - Beautiful interface with colors and animations
        - SSH Keyså…å¯†ç™»å½•åŠŸèƒ½
        - AIæ¨¡åž‹æ¸©åº¦è®¾ç½®åŠŸèƒ½
        - åŠ¨æ€é…ç½®æ–‡ä»¶æŒ‡å®šåŠŸèƒ½
        EOF
        else
          echo "Found $COMMIT_COUNT commits to analyze"
          
          # åˆ†æžæäº¤è®°å½•å¹¶åˆ†ç±»
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          DOCS=""
          BREAKING=""
          OTHER=""
          
          while IFS= read -r commit; do
            # æ£€æµ‹ç ´åæ€§æ›´æ”¹
            if [[ $commit == *"BREAKING CHANGE"* ]] || [[ $commit == *"!"* ]] && [[ $commit == *":"* ]]; then
              BREAKING="${BREAKING}- âš ï¸ ${commit}\n"
            # æ–°åŠŸèƒ½
            elif [[ $commit =~ ^feat(\(.+\))?:.*$ ]] || [[ $commit == *"æ·»åŠ "* ]] || [[ $commit == *"æ–°å¢ž"* ]]; then
              clean_msg=$(echo "$commit" | sed 's/^feat[^:]*: *//')
              FEATURES="${FEATURES}- ${clean_msg}\n"
            # é—®é¢˜ä¿®å¤
            elif [[ $commit =~ ^fix(\(.+\))?:.*$ ]] || [[ $commit == *"ä¿®å¤"* ]] || [[ $commit == *"è§£å†³"* ]]; then
              clean_msg=$(echo "$commit" | sed 's/^fix[^:]*: *//')
              FIXES="${FIXES}- ${clean_msg}\n"
            # æ€§èƒ½ä¼˜åŒ–å’Œæ”¹è¿›
            elif [[ $commit == *"ä¼˜åŒ–"* ]] || [[ $commit == *"improve"* ]] || [[ $commit == *"enhance"* ]] || [[ $commit == *"é‡æž„"* ]] || [[ $commit =~ ^refactor.*$ ]]; then
              IMPROVEMENTS="${IMPROVEMENTS}- ${commit}\n"
            # æ–‡æ¡£æ›´æ–°
            elif [[ $commit == *"æ–‡æ¡£"* ]] || [[ $commit == *"doc"* ]] || [[ $commit == *"README"* ]] || [[ $commit =~ ^docs.*$ ]]; then
              DOCS="${DOCS}- ${commit}\n"
            # å…¶ä»–æ›´æ”¹
            else
              OTHER="${OTHER}- ${commit}\n"
            fi
          done < <(git log --pretty=format:"%s" $COMMIT_RANGE)
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
        # SSHAI ${{ steps.version.outputs.VERSION }} Release
        
        ## ðŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹
        
        EOF
          
          # ä¼˜å…ˆæ˜¾ç¤ºç ´åæ€§æ›´æ”¹
          if [ ! -z "$BREAKING" ]; then
            cat >> release_notes.md << EOF
        ### âš ï¸ ç ´åæ€§æ›´æ”¹ (Breaking Changes)
        $(echo -e "$BREAKING")
        **è¯·åœ¨å‡çº§å‰ä»”ç»†é˜…è¯»ä¸Šè¿°æ›´æ”¹ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æ‚¨çš„é…ç½®æˆ–ä½¿ç”¨æ–¹å¼ã€‚**
        
        EOF
          fi
          
          if [ ! -z "$FEATURES" ]; then
            cat >> release_notes.md << EOF
        ### ðŸš€ æ–°åŠŸèƒ½ (New Features)
        $(echo -e "$FEATURES")
        EOF
          fi
          
          if [ ! -z "$FIXES" ]; then
            cat >> release_notes.md << EOF
        ### ðŸ› é—®é¢˜ä¿®å¤ (Bug Fixes)
        $(echo -e "$FIXES")
        EOF
          fi
          
          if [ ! -z "$IMPROVEMENTS" ]; then
            cat >> release_notes.md << EOF
        ### âš¡ æ€§èƒ½ä¼˜åŒ– (Improvements)
        $(echo -e "$IMPROVEMENTS")
        EOF
          fi
          
          if [ ! -z "$DOCS" ]; then
            cat >> release_notes.md << EOF
        ### ðŸ“– æ–‡æ¡£æ›´æ–° (Documentation)
        $(echo -e "$DOCS")
        EOF
          fi
          
          if [ ! -z "$OTHER" ]; then
            cat >> release_notes.md << EOF
        ### ðŸ”§ å…¶ä»–æ›´æ”¹ (Other Changes)
        $(echo -e "$OTHER")
        EOF
          fi
          
          cat >> release_notes.md << EOF
        
        ## ðŸŽ¯ æ ¸å¿ƒç‰¹æ€§ (Core Features)
        - SSH AI Assistant with embedded language packs
        - Multi-platform support (Linux, macOS, Windows)
        - Support for multiple AI models (DeepSeek, Hunyuan, etc.)
        - Real-time thinking display for compatible models
        - Configurable prompts and authentication
        - Beautiful interface with colors and animations
        - SSH Keyså…å¯†ç™»å½•åŠŸèƒ½
        - AIæ¨¡åž‹æ¸©åº¦è®¾ç½®åŠŸèƒ½
        - åŠ¨æ€é…ç½®æ–‡ä»¶æŒ‡å®šåŠŸèƒ½
        EOF
        fi
        
        # ç»§ç»­æ·»åŠ é€šç”¨å†…å®¹
        cat >> release_notes.md << EOF
        
        ## ðŸ“¦ Downloads
        Choose the appropriate package for your platform:

        ### Linux
        - **Linux AMD64**: \`sshai_linux_amd64_${{ steps.version.outputs.VERSION }}.zip\`
        - **Linux ARM64**: \`sshai_linux_arm64_${{ steps.version.outputs.VERSION }}.zip\`

        ### macOS
        - **macOS Intel**: \`sshai_darwin_amd64_${{ steps.version.outputs.VERSION }}.zip\`
        - **macOS Apple Silicon**: \`sshai_darwin_arm64_${{ steps.version.outputs.VERSION }}.zip\`

        ### Windows
        - **Windows AMD64**: \`sshai_windows_amd64_${{ steps.version.outputs.VERSION }}.zip\`

        ## ðŸ› ï¸ å®‰è£…æŒ‡å— (Installation Guide)
        
        ### é¦–æ¬¡å®‰è£… (First Installation)
        1. ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„å®‰è£…åŒ…
        2. è§£åŽ‹ç¼©æ–‡ä»¶
        3. å¤åˆ¶ \`config.yaml.example\` ä¸º \`config.yaml\` å¹¶é…ç½®æ‚¨çš„APIå¯†é’¥
        4. è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨SSH AIæœåŠ¡
        
        ### å‡çº§æŒ‡å— (Upgrade Guide)
        1. åœæ­¢å½“å‰è¿è¡Œçš„SSHAIæœåŠ¡
        2. å¤‡ä»½æ‚¨çš„ \`config.yaml\` é…ç½®æ–‡ä»¶
        3. ä¸‹è½½æ–°ç‰ˆæœ¬å¹¶è§£åŽ‹
        4. å°†å¤‡ä»½çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æ–°ç‰ˆæœ¬ç›®å½•
        5. å¯åŠ¨æ–°ç‰ˆæœ¬æœåŠ¡
        
        **æ³¨æ„**: å¦‚æžœå­˜åœ¨ç ´åæ€§æ›´æ”¹ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ›´æ”¹è¯´æ˜Žã€‚

        ## ðŸ“– æ–‡æ¡£ (Documentation)
        - [README (ä¸­æ–‡)](https://github.com/sshllm/sshai/blob/main/README.md)
        - [README (English)](https://github.com/sshllm/sshai/blob/main/README_EN.md)
        - [é…ç½®æŒ‡å— (Configuration Guide)](https://github.com/sshllm/sshai/blob/main/docs/CONFIG_GUIDE.md)

        ## ðŸ”§ å¿«é€Ÿå¼€å§‹ (Quick Start)
        
        ### Linux/macOS
        \`\`\`bash
        # ä¸‹è½½å¹¶è§£åŽ‹ (ä»¥Linux AMD64ä¸ºä¾‹)
        wget https://github.com/sshllm/sshai/releases/download/${{ steps.version.outputs.VERSION }}/sshai_linux_amd64_${{ steps.version.outputs.VERSION }}.zip
        unzip sshai_linux_amd64_${{ steps.version.outputs.VERSION }}.zip
        cd sshai_linux_amd64
        
        # é…ç½®APIå¯†é’¥
        cp config.yaml.example config.yaml
        nano config.yaml  # ç¼–è¾‘é…ç½®æ–‡ä»¶
        
        # å¯åŠ¨æœåŠ¡
        ./sshai_linux_amd64
        
        # ä»Žå¦ä¸€ä¸ªç»ˆç«¯è¿žæŽ¥
        ssh user@localhost -p 2213
        \`\`\`
        
        ### Windows
        \`\`\`powershell
        # è§£åŽ‹ä¸‹è½½çš„zipæ–‡ä»¶
        # å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶
        copy config.yaml.example config.yaml
        notepad config.yaml
        
        # å¯åŠ¨æœåŠ¡
        .\\sshai_windows_amd64.exe
        
        # ä½¿ç”¨SSHå®¢æˆ·ç«¯è¿žæŽ¥
        ssh user@localhost -p 2213
        \`\`\`

        ## ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯ (Version Info)
        - **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.VERSION }}
        - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Gitæäº¤**: $(git rev-parse --short HEAD)
        - **Goç‰ˆæœ¬**: $(go version | cut -d' ' -f3)
        - **æäº¤èŒƒå›´**: $COMMIT_RANGE
        - **åŒ…å«æäº¤æ•°**: $(git rev-list --count $COMMIT_RANGE)
        
        ## ðŸ”— ç›¸å…³é“¾æŽ¥ (Links)
        - [é¡¹ç›®ä¸»é¡µ (Homepage)](https://github.com/sshllm/sshai)
        - [ä½¿ç”¨æ–‡æ¡£ (Documentation)](https://github.com/sshllm/sshai/blob/main/docs/)
        - [é—®é¢˜åé¦ˆ (Issues)](https://github.com/sshllm/sshai/issues)
        - [è®¨è®ºåŒº (Discussions)](https://github.com/sshllm/sshai/discussions)
        
        ## ðŸ› é—®é¢˜åé¦ˆ (Bug Reports)
        å¦‚æžœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨æˆ‘ä»¬çš„ [GitHub Issues](https://github.com/sshllm/sshai/issues) é¡µé¢æŠ¥å‘Šã€‚
        
        ## ðŸ™ è‡´è°¢ (Acknowledgments)
        æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„æ”¯æŒï¼
        EOF
        
        echo "Generated release notes:"
        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: SSHAI ${{ steps.version.outputs.VERSION }}
        body_path: release_notes.md
        files: release_assets/*
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update latest release info
      run: |
        echo "âœ… Release ${{ steps.version.outputs.VERSION }} created successfully!"
        echo "ðŸ“¦ Assets uploaded:"
        ls -la release_assets/
        echo ""
        echo "ðŸ”— Release URL: https://github.com/sshllm/sshai/releases/tag/${{ steps.version.outputs.VERSION }}"
        echo "ðŸ“‹ Release notes generated from commits since last tag"
        echo "ðŸŽ‰ Release is now available for download!"